generator client { provider = "prisma-client-js" }
datasource db { provider = "postgresql"; url = env("DATABASE_URL") }

enum UserRole { ADMIN HR PAYROLL MANAGER EMPLOYEE ACCOUNTANT }

enum TimesheetStatus { DRAFT SUBMITTED APPROVED REJECTED }
enum AdjustmentType { EARNING DEDUCTION }

enum AccountType { ASSET LIABILITY EQUITY INCOME EXPENSE }
enum DocStatus { DRAFT ISSUED PAID VOID }
enum TxnType { DEPOSIT WITHDRAWAL TRANSFER }

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      UserRole @default(EMPLOYEE)
  createdAt DateTime @default(now())
  employee  Employee?
}

model AuditEvent {
  id         String   @id @default(cuid())
  actorId    String?
  actorEmail String?
  action     String
  entity     String
  entityId   String?
  before     Json?
  after      Json?
  createdAt  DateTime @default(now())
}

model Employee {
  id         String   @id @default(cuid())
  userId     String?  @unique
  user       User?    @relation(fields: [userId], references: [id])
  employeeNo String?  @unique
  firstName  String
  lastName   String
  status     String   @default("ACTIVE")
  hireDate   DateTime @default(now())
  jobTitle   String?
  department String?
  location   String?
  payType    String   @default("SALARY")
  rateCents  Int      @default(0)
  createdAt  DateTime @default(now())

  timeEntries TimeEntry[]
  timesheets  Timesheet[]
  ptoRequests PtoRequest[]
  payItems    PayRunItem[]
}

model TimeEntry {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  timesheetId String?
  timesheet   Timesheet? @relation(fields: [timesheetId], references: [id])
  startAt     DateTime
  endAt       DateTime?
  minutes     Int?
  notes       String?
  createdAt   DateTime @default(now())
}

model Timesheet {
  id          String         @id @default(cuid())
  employeeId  String
  employee    Employee       @relation(fields: [employeeId], references: [id])
  periodStart DateTime
  periodEnd   DateTime
  status      TimesheetStatus @default(DRAFT)
  submittedAt DateTime?
  approvedAt  DateTime?
  decidedById String?
  decidedBy   User?          @relation(fields: [decidedById], references: [id])
  entries     TimeEntry[]
  createdAt   DateTime @default(now())
  @@index([employeeId, periodStart, periodEnd])
}

model PtoPolicy {
  id          String   @id @default(cuid())
  name        String   @unique
  accrualType String   @default("MONTHLY")
  accrualRate Float    @default(0)
  maxBalance  Float?
  createdAt   DateTime @default(now())
}

model PtoRequest {
  id         String    @id @default(cuid())
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id])
  policyId   String
  policy     PtoPolicy @relation(fields: [policyId], references: [id])
  startDate  DateTime
  endDate    DateTime
  hours      Float
  status     String    @default("PENDING")
  reason     String?
  createdAt  DateTime  @default(now())
  decidedAt  DateTime?
}

model PayGroup {
  id        String   @id @default(cuid())
  name      String   @unique
  cadence   String   @default("BIWEEKLY")
  createdAt DateTime @default(now())
  runs      PayRun[]
}

model PayRun {
  id         String   @id @default(cuid())
  payGroupId String
  payGroup   PayGroup @relation(fields: [payGroupId], references: [id])
  status     String   @default("DRAFT")
  notes      String?
  periodStart DateTime?
  periodEnd   DateTime?
  createdAt  DateTime @default(now())
  finalizedAt DateTime?
  items      PayRunItem[]
  exceptions PayException[]
  adjustments PayRunAdjustment[]
}

model PayRunItem {
  id         String   @id @default(cuid())
  payRunId   String
  payRun     PayRun   @relation(fields: [payRunId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  grossCents Int      @default(0)
  netCents   Int      @default(0)
  taxesCents Int      @default(0)
  deductionsCents Int @default(0)
  breakdown  Json?
}

model PayRunAdjustment {
  id         String   @id @default(cuid())
  payRunId   String
  payRun     PayRun   @relation(fields: [payRunId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  type       AdjustmentType
  label      String
  amountCents Int
  taxable    Boolean  @default(true)
  preTax     Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model PayException {
  id         String  @id @default(cuid())
  payRunId   String
  payRun     PayRun  @relation(fields: [payRunId], references: [id])
  employeeId String?
  kind       String
  message    String
  createdAt  DateTime @default(now())
}

model Task {
  id         String   @id @default(cuid())
  title      String
  status     String   @default("OPEN")
  dueAt      DateTime?
  createdAt  DateTime @default(now())
}

/* =========================
   BOOKKEEPING (V3)
   ========================= */

model Account {
  id        String      @id @default(cuid())
  code      String      @unique
  name      String
  type      AccountType
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  lines     JournalLine[]
}

model JournalEntry {
  id        String      @id @default(cuid())
  memo      String?
  source    String?     // e.g. INVOICE:invId
  postedAt  DateTime    @default(now())
  createdAt DateTime    @default(now())
  lines     JournalLine[]
}

model JournalLine {
  id          String      @id @default(cuid())
  entryId     String
  entry       JournalEntry @relation(fields: [entryId], references: [id])
  accountId   String
  account     Account     @relation(fields: [accountId], references: [id])
  description String?
  debitCents  Int         @default(0)
  creditCents Int         @default(0)
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?
  createdAt DateTime @default(now())
  invoices  Invoice[]
}

model Vendor {
  id        String   @id @default(cuid())
  name      String
  email     String?
  createdAt DateTime @default(now())
  bills     Bill[]
}

model Invoice {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])
  status      DocStatus @default(DRAFT)
  issueDate   DateTime  @default(now())
  dueDate     DateTime?
  memo        String?
  subtotalCents Int     @default(0)
  taxCents      Int     @default(0)
  totalCents    Int     @default(0)
  createdAt   DateTime  @default(now())
  lines       InvoiceLine[]
  payments    Payment[]
  sourceEntryId String?
  sourceEntry  JournalEntry? @relation(fields: [sourceEntryId], references: [id])
}

model InvoiceLine {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
  description String
  qty       Int     @default(1)
  unitCents Int     @default(0)
  amountCents Int   @default(0)
}

model Bill {
  id          String   @id @default(cuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id])
  status      DocStatus @default(DRAFT)
  issueDate   DateTime  @default(now())
  dueDate     DateTime?
  memo        String?
  totalCents  Int       @default(0)
  createdAt   DateTime  @default(now())
  lines       BillLine[]
  payments    Payment[]
  sourceEntryId String?
  sourceEntry  JournalEntry? @relation(fields: [sourceEntryId], references: [id])
}

model BillLine {
  id        String @id @default(cuid())
  billId    String
  bill      Bill   @relation(fields: [billId], references: [id])
  description String
  amountCents Int  @default(0)
}

model BankAccount {
  id        String  @id @default(cuid())
  name      String
  currency  String  @default("USD")
  createdAt DateTime @default(now())
  txns      BankTxn[]
}

model BankTxn {
  id            String   @id @default(cuid())
  bankAccountId String
  bankAccount   BankAccount @relation(fields: [bankAccountId], references: [id])
  type          TxnType
  postedAt      DateTime @default(now())
  description   String
  amountCents   Int
  matchedEntryId String?
  matchedEntry   JournalEntry? @relation(fields: [matchedEntryId], references: [id])
}

model Payment {
  id         String   @id @default(cuid())
  kind       String   // "AR" or "AP"
  invoiceId  String?
  invoice    Invoice? @relation(fields: [invoiceId], references: [id])
  billId     String?
  bill       Bill?    @relation(fields: [billId], references: [id])
  amountCents Int
  paidAt     DateTime @default(now())
  method     String?  // cash, card, ach
  createdAt  DateTime @default(now())
  sourceEntryId String?
  sourceEntry  JournalEntry? @relation(fields: [sourceEntryId], references: [id])
}

model Period {
  id        String   @id @default(cuid())
  name      String   @unique // e.g. 2025-12
  startDate DateTime
  endDate   DateTime
  isClosed  Boolean  @default(false)
  closedAt  DateTime?
  createdAt DateTime @default(now())
}

model Attachment {
  id        String   @id @default(cuid())
  entity    String   // "Invoice" | "Bill" | "JournalEntry"
  entityId  String
  fileName  String
  mimeType  String?
  sizeBytes Int?
  note      String?
  createdAt DateTime @default(now())
}

model SalesTaxRate {
  id        String   @id @default(cuid())
  name      String   @unique
  rateBps   Int      @default(0) // basis points: 825 = 8.25%
  createdAt DateTime @default(now())
}

model RecurringTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  cadence   String   @default("MONTHLY") // MONTHLY/WEEKLY
  nextRunAt DateTime
  memo      String?
  linesJson Json     // [{accountId,debitCents,creditCents,description}]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model ReconciliationSession {
  id            String   @id @default(cuid())
  bankAccountId String
  bankAccount   BankAccount @relation(fields: [bankAccountId], references: [id])
  statementStart DateTime
  statementEnd   DateTime
  status        String   @default("OPEN")
  createdAt     DateTime @default(now())
  matches       BankMatch[]
}

model BankMatch {
  id            String   @id @default(cuid())
  sessionId     String
  session       ReconciliationSession @relation(fields: [sessionId], references: [id])
  bankTxnId     String
  bankTxn       BankTxn @relation(fields: [bankTxnId], references: [id])
  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  createdAt     DateTime @default(now())
}

model CsvImportJob {
  id        String   @id @default(cuid())
  kind      String   // "BANK_TXN"
  status    String   @default("DONE")
  rowCount  Int      @default(0)
  createdAt DateTime @default(now())
  rawSample String?
}



model AnalyticsEvent {
  id          String   @id @default(cuid())
  occurredAt  DateTime @default(now())
  actorId     String?
  actorEmail  String?
  actorRole   UserRole?
  sessionId   String?
  event       String   // e.g. page_view, create_invoice, reconcile_match
  entity      String?  // Invoice, Bill, PayRun, etc.
  entityId    String?
  path        String?
  method      String?
  status      Int?
  durationMs  Int?
  props       Json?
  createdAt   DateTime @default(now())

  @@index([occurredAt])
  @@index([event])
  @@index([entity, entityId])
  @@index([actorEmail])
}

model MetricSnapshot {
  id          String   @id @default(cuid())
  asOfDate    DateTime // day bucket (UTC midnight)
  metric      String   // e.g. invoices_issued, payroll_runs, cash_balance
  valueNumber Float?
  valueCents  Int?
  dims        Json?    // {department:"Ops"} etc.
  createdAt   DateTime @default(now())

  @@index([asOfDate, metric])
}
